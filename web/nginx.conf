##
# nginx.conf
# Static hosting for the MCPX Admin SPA + reverse proxy to the Admin API.
#
# Why this setup:
# - Serves the Vite-built SPA from /usr/share/nginx/html.
# - SPA history API fallback (routes resolve to /index.html).
# - Proxies API endpoints to the API container at http://api:5000.
# - Special handling for SSE (/sessions/stream): disables buffering to keep
#   events flowing and preserves HTTP/1.1 semantics.
#
# Usage:
# - This file is copied by the /web/Dockerfile to /etc/nginx/conf.d/default.conf
# - docker-compose provides an "api" service reachable at http://api:5000
##

server {
  listen 80;
  server_name _;

  # --- SPA static files ---
  root /usr/share/nginx/html;
  index index.html;

  # History API fallback for React Router
  location / {
    try_files $uri /index.html;
  }

  # --- Admin API proxy (simple GET endpoints) ---
  location /health     { proxy_pass http://api:5000/health; }
  location /readiness  { proxy_pass http://api:5000/readiness; }
  location /config     { proxy_pass http://api:5000/config; }
  location /access     { proxy_pass http://api:5000/access; }

  # --- Server-Sent Events (SSE) stream ---
  location /sessions/stream {
    proxy_http_version 1.1;

    # Disable buffering to stream events as they arrive
    proxy_buffering off;
    proxy_cache off;

    # Prevent Nginx from attempting to compress the stream
    gzip off;

    # Avoid Connection: keep-alive side-effects for SSE
    proxy_set_header Connection '';

    # Hint to some proxies/CDNs not to buffer
    proxy_set_header X-Accel-Buffering no;

    # Forward request to API service
    proxy_pass http://api:5000/sessions/stream;
  }

  # Optional: tighten headers for static content (tweak as needed)
  location ~* \.(?:css|js|woff2?|ttf|eot|png|jpg|jpeg|gif|svg)$ {
    add_header X-Content-Type-Options nosniff;
    access_log off;
    expires 7d;
    try_files $uri =404;
  }
}
